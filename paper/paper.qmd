---
title: "Elephant Seal Age JAE Intraspecific Variation"
format: 
  html: 
    echo: false 
editor: visual
bibliography: references.bib
---

```{r}
#| label: setup
#| include: false  

library(tidyverse)
library(ggthemes)
library(cowplot)

sealdat <- read_csv(here::here("data/raw/128L pull 2023_06_29.csv"), 
                    show_col_types = FALSE) %>% 
  mutate(observed = if_else(observed == "B", "Breeder", "Non-breeder"))

```

## Introduction

This paper similar to another paper about polar bears (*Ursus maritimus*) [@naciri2022].

Our hypotheses:

1.  Elephant seal reproductive success declines with age.

2.  Reproductive declines persist to the next generation (maternal effect senescence).Â 

3.  Seals optimize their annual cycle timing to compensate for reproductive declines.

## Methods

## Results 

### H1: Age distribution and breeding success

```{r}
#| label: fig-age_dist

#Age distribution panel A = COUNTS, B = PERCENTAGES

sealdat %>% 
  group_by(age, observed) %>% 
  count(age) %>% 
  ggplot(aes(x = age, y = n, fill = observed)) + 
  geom_col() + 
  labs(x = "Number of individuals", y = "Age") + 
  theme_few()
  
#I want each of these bars to show the proportion of breeders and non breeders for each age

```

### H2: Maternal effect senescence 

As maternal age increases, pup sex skews slightly towards males. Pup survival declines slightly with maternal age, but pup recruitment is not significantly affected by maternal age (@fig-repro_age). Reproductive declines therefore do not persist to the next generation.

```{r}
#| label: fig-repro_age
#| fig-cap: "Pup sex skews slightly towards males with increasing maternal age. Pup survival decreases slightly, but survival and recruitment are not significantly affected by maternal age."
#| fig-width: 6
#| fig-height: 6

#Pup sex shifts towards males with increasing maternal age.

pup_sex <- sealdat %>% 
  filter(pupsex %in% c("M", "F"), 
         age < 18) %>% 
  group_by(age, pupsex) %>%
  count(pupsex) %>% 
  pivot_wider(values_from = n, names_from = pupsex) %>% 
  mutate(num = M + F,
         percf = F / num,
         se = (percf * (1 - percf) / num)^0.5) %>% 
  ggplot(aes(x = age, y = percf, weight = num)) +
  geom_point() +
  geom_errorbar(aes(ymin = percf - se, ymax = percf + se), width = 0.2) +
  geom_hline(yintercept = 0.5, lty = 2) +
  stat_smooth(method = "glm", method.args = list(family = "binomial"), formula = y ~ x) +
  scale_y_continuous(labels = scales::percent, limits = c(0, NA)) +
  labs(x = "Maternal Age (Years)", y = "% Pups Female") +
  theme_few()

#Pup survival doesn't change with increased maternal age.

pup_surv_recruit <- sealdat %>% 
  mutate(pup_surv = ifelse(pupseeneveragain > 0, 1, 0)) %>% 
  filter(pupsex == "F") %>% 
  group_by(age) %>%
  summarize(n_surv = sum(!is.na(pup_surv)),
            mean_surv = sum(pup_surv, na.rm = TRUE) / n_surv,  
            se_surv = (mean_surv * (1 - mean_surv) / n_surv)^0.5,
            n_recruit = sum(!is.na(puprecruited)), 
            mean_recruit = sum(puprecruited, na.rm = TRUE) / n_recruit, 
            se_recruit = (mean_recruit * (1 - mean_recruit) / n_recruit)^0.5)  %>%  
  pivot_longer(cols = c(mean_surv, se_surv, mean_recruit, se_recruit), 
               names_to = c("stat", "metric"), 
               names_pattern = "(.*)_(.*)") %>% 
  pivot_wider(names_from = "stat", 
              values_from = "value") %>% 
  mutate(low = mean - se, 
         high = mean + se, 
         age = age + ifelse(metric == "surv", -0.1, 0.1), 
         metric = factor(metric, 
                         levels = c("recruit", "surv"), 
                         labels = c("Recruitment", "1st Year Survival"))) %>% 
  filter(n_surv > 5) %>% 
  ggplot(aes(x = age, y = mean, color = metric)) + 
  geom_pointrange(aes(ymin = low, ymax = high)) +
  geom_smooth(aes(weight = n_surv), 
              method = "glm", 
              method.args = list(family = binomial), 
              formula = y ~ x) +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, .5)) + 
  labs(x = "Maternal Age (Years)", y = "% Pups") +
  theme_few() + 
  theme(legend.position = c(0.1,0.97), 
        legend.justification = c(0,1), 
        legend.title = element_blank(), 
        legend.direction = "horizontal")

plot_grid(pup_sex, pup_surv_recruit, ncol = 1, labels = "AUTO")

```

### H3: Changes to annual cycle timing with increased maternal age

In order to create the timing figure, I need a csv with these columns: breeding arrival DOY, breeding departure DOY, molt arrival DOY, molt departure DOY.

-   breeding arrival DOY = firstobsbreeddoy

-   breeding departure DOY = firstobsbreeddoy + breeddur

-   molt arrival DOY = lastobsmoltdoy - moltdur

-   molt departure DOY = lastobsmoltdoy

## Discussion

## 
